<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11316670180"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'AW-11316670180');
    </script>
    <meta name="description" content>
    <meta name="author" content>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>RSSI NGO - visitor Form</title>
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon" />
    <!-- Bootstrap CSS -->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Template Main CSS File -->
    <link href="/css/main.css?v=1.2.0" rel="stylesheet">
    <style>
        .required-asterisk {
            color: red;
        }
    </style>

</head>

<body>
    <!-- ======= Header ======= -->
    <div id="header"></div>
    <!-- End Header -->
    <main id="main">
        <!-- ======= Breadcrumbs ======= -->
        <div class="breadcrumbs">
            <div class="container">

                <div class="d-flex justify-content-between align-items-center">
                    <h2>Visit us</h2>
                    <ol>
                        <li><a href="index">Home</a></li>
                        <li>Visit us</li>
                    </ol>
                </div>

            </div>
        </div>

        <!-- End Breadcrumbs -->
        <section class="sample-page">
            <div class="container">
                <!-- Part 1: visitor Information -->
                <form action="#" method="POST" name="visitorInfoForm" id="visitorInfoForm"
                    enctype="multipart/form-data">
                    <input type="hidden" name="form-type" value="visitor_form">
                    <div class="mb-3">
                        <label for="visitorType" class="form-label">Have you
                            visited earlier?</label>
                        <select class="form-select" id="visitorType" name="visitorType"
                            onchange="togglevisitorSections()" required>
                            <option value>Select</option>
                            <option value="new">No, I am a first-time
                                visitor</option>
                            <option value="existing">Yes, I have visited
                                earlier</option>
                        </select>
                    </div>
                    <div id="existingvisitorInfo" style="display: none;">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="contactnumber_verify"
                                name="contactnumber_verify" pattern="[0-9]{10}" placeholder="Enter your contact number"
                                oninput="validateContactNumber(this)">
                            <button type="submit" class="btn btn-primary" id="verifybutton">Find your details</button>
                        </div>
                        <span id="contactnumber_error" style="color: red;"></span>
                    </div>

                    <script>
                        function validateContactNumber(input) {
                            var errorMessage = document.getElementById("contactnumber_error");
                            var verifyButton = document.getElementById("verifybutton");

                            if (!input.checkValidity()) {
                                errorMessage.textContent = "Please enter a valid 10-digit contact number.";
                                verifyButton.disabled = true;
                            } else {
                                errorMessage.textContent = "";
                                verifyButton.disabled = false;
                            }
                        }
                    </script>

                    <!-- Get user data -->
                    <div id="verificationResult" style="display: none;">
                        <input type="hidden" id="tel" name="tel" class="form-control" readonly>
                        <div class="mb-3">
                            <label for="visitorName" class="form-label">Visitor Name</label>
                            <input type="text" id="visitorName" class="form-control" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="visitorEmail" class="form-label">Email Address</label>
                            <input type="email" id="visitorEmail" class="form-control" readonly>
                        </div>
                    </div>

                    <!-- New visitor Information -->
                    <div id="newvisitorInfo" style="display: none;">
                        <div class="mb-3">
                            <label for="fullName" class="form-label">Full
                                Name</label>
                            <input type="text" class="form-control" id="fullName" name="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email
                                Address</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>

                        <div class="mb-3">
                            <label for="contactNumberNew" class="form-label">Contact Number</label>
                            <input type="tel" class="form-control" id="contactNumberNew" name="contactNumberNew"
                                pattern="[0-9]{10}" required>
                            <small id="type-of-admission-help" class="form-text text-muted">Enter a WhatsApp number to
                                receive application process alerts.</small><br>
                            <small id="contactNumberError" class="form-text text-danger"></small>
                        </div>

                        <script>
                            function validateInput() {
                                document.getElementById('contactNumberError').textContent = this.validity.patternMismatch ? 'Please enter a valid 10-digit number.' : '';
                            }

                            const inputElement = document.getElementById('contactNumberNew');
                            inputElement.addEventListener('input', validateInput);
                        </script>

                        <div class="mb-3">
                            <label for="nationalId" class="form-label">Upload Aadhar</label>
                            <input type="file" class="form-control" id="nationalId" name="nationalId" required>
                        </div>

                        <div class="mb-3">
                            <label for="photo" class="form-label">Upload
                                Photo</label>
                            <input type="file" class="form-control" id="photo" name="photo" required
                                accept="image/*;capture=camera">
                            <img src="/img/photo_guide.jpg" alt="Uploaded Photo"
                                style="max-width: 200px; max-height: 200px;">
                        </div>
                    </div>

                    <!-- visitor Amount -->
                    <div id="visitinfo" style="display: none;">

                        <div class="mb-3">
                            <label for="visitbranch" class="form-label">Which branch do you want
                                to visit?</label>
                            <div class="input-group">
                                <select class="form-select" id="visitbranch" name="visitbranch" required>
                                    <option value disabled selected>Select
                                        Branch</option>
                                    <option value="Gomti Nagar, Lucknow">Gomti
                                        Nagar, Lucknow</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="visitstartdatetime" class="form-label">Visit start date</label>
                                    <input type="datetime-local" class="form-control" id="visitstartdatetime"
                                        name="visitstartdatetime" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="visitenddate" class="form-label">Visit end date</label>
                                    <input type="date" class="form-control" id="visitenddate" name="visitenddate"
                                        required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="visitpurpose" class="form-label">Purpose of visit</label>
                            <div class="form-check">
                                <input type="radio" class="form-check-input" id="college_project" name="visitpurpose"
                                    value="College/University project as a part of community service" required>
                                <label for="college_project">College/University
                                    project as a part of community
                                    service</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" class="form-check-input" id="other" name="visitpurpose"
                                    value="Other">
                                <label for="other">Other</label>
                                <textarea class="form-control" id="other_reason" name="other_reason"
                                    placeholder="Please specify reason" style="display: none;"></textarea>
                            </div>
                        </div>

                        <div class="mb-3" id="additionalFields" style="display: none;">
                            <div class="mb-3">
                                <label for="institutename" class="form-label">Institute Name</label>
                                <input type="text" class="form-control" id="institutename" name="institutename"
                                    required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="enrollmentnumber" class="form-label">Enrollment Number</label>
                                        <input type="text" class="form-control" id="enrollmentnumber"
                                            name="enrollmentnumber" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="instituteid" class="form-label">Institute ID</label>
                                        <input type="file" class="form-control" id="instituteid" name="instituteid"
                                            accept=".pdf,.doc,.docx" required>
                                        <small id="type-of-admission-help" class="form-text text-muted">Please upload a
                                            copy of your college ID or any other document that shows your student ID or
                                            enrollment number.</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="mentoremail" class="form-label">Mentor Email</label>
                                <input type="email" class="form-control" id="mentoremail" name="mentoremail" required>
                            </div>
                            <div class="mb-3">
                                <label for="paymentdoc" class="form-label">Payment Document</label>
                                <input type="file" class="form-control" id="paymentdoc" name="paymentdoc"
                                    accept=".pdf,.doc,.docx" required>
                                <small id="type-of-admission-help" class="form-text text-muted">The one-time application
                                    fee is Rs. 200 and must be paid during registration.</small>
                            </div>
                            <p>
                                Click <a
                                    href="https://eazypay.icicibank.com/eazypayLink?P1=ldvYO7WCMgfIXlGHmwXsxg==">here</a>
                                to
                                complete the payment. In case of any issues with payment completion or providing a valid
                                payment document, your application will be temporarily held for two days to ensure
                                everything is in order. If payment isn't received within this time, unfortunately, the
                                held request will be cancelled.
                            </p>
                        </div>

                        <div class="mb-3">
                            <label for="message" class="form-label">Message
                                (Optional)</label>
                            <textarea class="form-control" id="message" name="message" rows="4"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="declaration" name="declaration"
                                required>
                            <label class="form-check-label" for="declaration">I agree to the terms and
                                conditions</label>
                        </div>

                        <button type="submit" class="btn btn-primary" id="visitButton" disabled>Submit</button>
                    </div>
                </form>

                <form name="get_details_form" id="get_details_form" action="#" method="POST">
                    <input type="hidden" name="form-type" value="get_details_visit">
                    <input type="hidden" name="contactnumber_verify_input">
                </form>
            </div>
        </section>
        <!-- Bootstrap Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p id="loadingMessage">Submission in progress.
                                Please do not close or reload this page.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- ======= Footer ======= -->
    <div id="footer"></div>
    <!-- End Footer -->
    <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Load jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="/js/main.js?v=1.0.2"></script>
    <!-- JavaScript to handle form logic -->
    <script>
        var contactNumberInput = document.getElementById("contactnumber_verify");
        var contactNumberVerifyInput = document.getElementsByName("contactnumber_verify_input")[0];
        var visitorNameInput = document.getElementById("visitorName");
        var visitorEmailInput = document.getElementById("visitorEmail");
        var telInput = document.getElementById("tel");
        var verificationResultDiv = document.getElementById("verificationResult");
        var visitButton = document.getElementById('visitButton');
        var newvisitorInfo = document.getElementById('newvisitorInfo');

        // Add this flag here
        let isContactVerified = false;

        contactNumberInput.addEventListener("input", function (event) {
            contactNumberVerifyInput.value = this.value;
        });

        // Dynamically set the base script URL based on the environment
        const scriptURL = window.location.hostname === 'localhost'
            ? 'http://localhost:8082/rssi-member/payment-api.php'
            : 'https://login.rssi.in/rssi-member/payment-api.php';

        // Function to update the 'required' attribute of fields based on visibility
        function updateRequiredFields() {
            const requiredFields = document.querySelectorAll('[required]');

            requiredFields.forEach(field => {
                const label = document.querySelector(`label[for="${field.id}"]`);
                if (label) {
                    const hasAsterisk = label.querySelector('.required-asterisk');

                    if (field.required && !hasAsterisk) {
                        const asterisk = document.createElement('span');
                        asterisk.className = 'required-asterisk';
                        asterisk.textContent = ' *';
                        label.appendChild(asterisk);
                    } else if ((!field.offsetParent || !field.required) && hasAsterisk) {
                        label.removeChild(hasAsterisk);
                        field.required = false;
                    }
                }
            });
        }

        // Call the function initially to set up the required fields
        updateRequiredFields();

        // Function to handle the "verifybutton" click event
        function handleVerifyButtonClick(event) {
            event.preventDefault(); // prevent default form submission

            const verifyButton = document.getElementById("verifybutton");
            // Save original button text
            const originalText = verifyButton.innerHTML;

            // Disable button and show spinner
            verifyButton.disabled = true;
            verifyButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Finding...';

            fetch(scriptURL, {
                method: 'POST',
                body: new FormData(document.forms['get_details_form'])
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        visitorNameInput.value = data.data.fullname;
                        visitorEmailInput.value = data.data.email;
                        telInput.value = data.data.tel;
                        verificationResultDiv.style.display = "block"; // Show the result div
                        visitinfo.style.display = 'block';
                        visitButton.disabled = false;
                        alert("User data fetched successfully!");

                        // Disable the contact number input and button after successful verification
                        contactNumberInput.disabled = true;
                        verifyButton.disabled = true;

                    } else if (data.status === 'no_records') {
                        verificationResultDiv.style.display = "none"; // Hide the result div
                        visitinfo.style.display = 'none';
                        visitButton.disabled = true;
                        visitorNameInput.value = "";
                        visitorEmailInput.value = "";
                        telInput.value = "";
                        alert("No records found in the database. Register as a new user.");

                        // Reset button to original state
                        verifyButton.disabled = false;
                        verifyButton.innerHTML = originalText;
                    } else {
                        console.log('Error:', data.message);
                        alert("Error retrieving user data. Please try again later or contact support.");

                        // Reset button to original state
                        verifyButton.disabled = false;
                        verifyButton.innerHTML = originalText;
                    }

                    // Reset button to original state
                    verifyButton.innerHTML = originalText;

                    // Call the updateRequiredFields() function after handling the verify button click
                    updateRequiredFields();
                })
                .catch(error => {
                    console.log('Error:', error);
                    alert("Error fetching user data. Please try again later or contact support.");

                    // Reset button to original state on error
                    verifyButton.disabled = false;
                    verifyButton.innerHTML = originalText;

                    // Call the updateRequiredFields() function after handling the verify button click
                    updateRequiredFields();
                });
        }

        // Add event listener to the "verifybutton" element
        document.getElementById("verifybutton").addEventListener("click", handleVerifyButtonClick);


        // JavaScript function to toggle visitor sections based on visitor type
        function togglevisitorSections() {
            const visitorType = document.getElementById('visitorType').value;
            const existingvisitorInfo = document.getElementById('existingvisitorInfo');
            const newvisitorInfo = document.getElementById('newvisitorInfo');
            const verificationResult = document.getElementById('verificationResult');
            const visitinfoSection = document.getElementById('visitinfo');
            const contactNumberInput = document.getElementById('contactnumber_verify');
            const verifyButton = document.getElementById('verifybutton');

            if (visitorType === 'existing') {
                existingvisitorInfo.style.display = 'block';
                newvisitorInfo.style.display = 'none';
                verificationResult.style.display = 'none';
                visitinfoSection.style.display = 'none';
                visitButton.disabled = true;

                // Reset contact number field and button if they were disabled from previous verification
                if (contactNumberInput) {
                    contactNumberInput.disabled = false;
                    contactNumberInput.removeAttribute('readonly');
                }
                if (verifyButton) {
                    verifyButton.disabled = false;
                    verifyButton.innerHTML = 'Find your details';
                    verifyButton.classList.remove('btn-success');
                    verifyButton.classList.add('btn-primary');
                }
            } else if (visitorType === 'new') {
                existingvisitorInfo.style.display = 'none';
                newvisitorInfo.style.display = 'block';
                verificationResult.style.display = 'none';
                visitinfoSection.style.display = 'block';
                visitButton.disabled = false;
            } else {
                existingvisitorInfo.style.display = 'none';
                newvisitorInfo.style.display = 'none';
                verificationResult.style.display = 'none';
                visitinfoSection.style.display = 'none';
                visitButton.disabled = true;
            }
        }
        // Function to handle the visitor type change event
        function handlevisitorTypeChange() {
            const visitorType = document.getElementById("visitorType").value;
            const fullNameInput = document.getElementById("fullName");
            const emailInput = document.getElementById("email");
            const contactNumberNewInput = document.getElementById("contactNumberNew");
            const nationalIdInput = document.getElementById("nationalId");
            const photoInput = document.getElementById("photo");

            // Set required attribute based on the visitor type
            if (visitorType === "existing") {
                fullNameInput.removeAttribute("required");
                emailInput.removeAttribute("required");
                contactNumberNewInput.removeAttribute("required");
                nationalIdInput.removeAttribute("required");
                photoInput.removeAttribute("required");
            } else if (visitorType === "new") {
                fullNameInput.setAttribute("required", true);
                emailInput.setAttribute("required", true);
                contactNumberNewInput.setAttribute("required", true);
                nationalIdInput.setAttribute("required", true);
                photoInput.setAttribute("required", true);
            }
        }

        // Add event listener to the "visitorType" element
        document.getElementById("visitorType").addEventListener("change", handlevisitorTypeChange);
    </script>
    <script>
        // Function to show/hide and mark/unmark fields as required based on the selected value of the radio button
        function toggleFields() {
            var visitPurpose = document.querySelector('input[name="visitpurpose"]:checked').value;
            var additionalFields = document.getElementById('additionalFields');

            if (visitPurpose === 'College/University project as a part of community service') {
                additionalFields.style.display = 'block';

                // Mark fields as required
                document.getElementById('institutename').setAttribute('required', '');
                document.getElementById('enrollmentnumber').setAttribute('required', '');
                document.getElementById('instituteid').setAttribute('required', '');
                document.getElementById('mentoremail').setAttribute('required', '');
                document.getElementById('paymentdoc').setAttribute('required', '');
            } else {
                additionalFields.style.display = 'none';

                // Remove required attribute
                document.getElementById('institutename').removeAttribute('required');
                document.getElementById('enrollmentnumber').removeAttribute('required');
                document.getElementById('instituteid').removeAttribute('required');
                document.getElementById('mentoremail').removeAttribute('required');
                document.getElementById('paymentdoc').removeAttribute('required');
            }
            // Call the updateRequiredFields() function after handling the verify button click
            updateRequiredFields();
        }

        // Add event listener to radio buttons
        var radioButtons = document.querySelectorAll('input[name="visitpurpose"]');
        radioButtons.forEach(function (radioButton) {
            radioButton.addEventListener('change', toggleFields);
        });
    </script>
    <script>
        const visitorForm = document.getElementById("visitorInfoForm");

        document.getElementById("visitButton").addEventListener("click", async function (event) {
            event.preventDefault(); // Prevent default form submission

            if (!visitorForm.checkValidity()) {
                visitorForm.reportValidity(); // Show the default validation messages
                return;
            }

            // Disable the donate button immediately upon form submission
            this.disabled = true;
            // Show the Bootstrap modal
            const myModal = new bootstrap.Modal(document.getElementById("myModal"), {
                backdrop: 'static',
                keyboard: false
            });
            myModal.show();

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: new FormData(visitorForm)
                });
                const result = await response.json();

                console.log("API Response:", result); // For testing purposes, log the entire response

                if (!result.error) {
                    alert(`Submitted successfully! visitor reference ID: ${result.visitorId}`);
                    visitorForm.reset(); // Reset the form after successful submission
                    location.reload(); // Reload the page after successful submission
                } else {
                    if (result.errorMessage === "") {
                        alert("Error occurred during form submission. Please try again later.");
                    } else if (result.errorMessage === "already_registered") {
                        alert("Oops! You are already registered in our database. Please proceed as an existing visitor.");
                    } else {
                        alert("Unknown error occurred during form submission.");
                    }
                }
            } catch (error) {
                console.error(error);
                alert("Error occurred during form submission. Please try again later.");
            } finally {
                // Re-enable the donate button after the form submission process is finished
                this.disabled = false;
                myModal.hide();
            }
        });
    </script>
    <script>
        $(document).ready(function () {
            $('input[type="radio"]').change(function () {
                if ($(this).val() == 'Other') {
                    $('#other_reason').show().attr('required', 'required');
                } else {
                    $('#other_reason').hide().removeAttr('required').val('');
                }
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/gh/manucaralmo/GlowCookies@3.0.1/src/glowCookies.min.js"></script>
    <script>
        glowCookies.start('en', {
            analytics: 'G-S25QWTFJ2S',
            policyLink: 'disclaimer'
        });
    </script>
</body>

</html>