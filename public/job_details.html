<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11316670180"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'AW-11316670180');
    </script>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>RSSI - Job Details</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="/img/favicon.ico" rel="icon">
    <link href="/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Vendor CSS Files -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Template Main CSS File -->
    <link href="/css/main.css" rel="stylesheet">

    <style>
        .job-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .job-detail-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            background-color: white;
        }

        .job-detail-card h5 {
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .detail-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f5f5f5;
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            min-width: 150px;
            display: inline-block;
        }

        .company-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .loading-container {
            text-align: center;
            padding: 100px 20px;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(function () {
            $("#header").load("/header.html");
            $("#footer").load("/footer.html");
        });
    </script>
</head>

<body>

    <!-- ======= Header ======= -->
    <div id="header"></div>
    <!-- End Header -->

    <main id="main">

        <!-- ======= Breadcrumbs ======= -->
        <div class="breadcrumbs">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 id="pageTitle">Job Details</h2>
                    <ol>
                        <li><a href="index">Home</a></li>
                        <li><a href="jobs.html">Jobs</a></li>
                        <li>Job Details</li>
                    </ol>
                </div>
            </div>
        </div>
        <!-- End Breadcrumbs -->

        <section class="sample-page">
            <div class="container" data-aos="fade-up">

                <!-- Loading State -->
                <div class="loading-container" id="loadingContainer">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading job details...</p>
                </div>

                <!-- Error State -->
                <div class="alert alert-danger" id="errorContainer" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="errorMessage">Unable to load job details.</span>
                </div>

                <!-- Job Details Container -->
                <div id="jobDetailsContainer" style="display: none;">

                    <!-- Job Header -->
                    <div class="job-header">
                        <div class="container">
                            <div class="row align-items-center">
                                <div class="col-md-9">
                                    <h2 id="jobTitle"></h2>
                                    <div class="d-flex align-items-center mt-3">
                                        <i class="bi bi-building me-2"></i>
                                        <h4 id="companyName" class="mb-0"></h4>
                                    </div>
                                    <div class="d-flex flex-wrap gap-3 mt-3">
                                        <span><i class="bi bi-geo-alt me-1"></i> <span id="jobLocation"></span></span>
                                        <span><i class="bi bi-briefcase me-1"></i> <span id="jobType"></span></span>
                                        <span><i class="bi bi-people me-1"></i> <span id="vacancies"></span>
                                            Vacancies</span>
                                        <span><i class="bi bi-calendar-check me-1"></i> Apply by: <span
                                                id="applyBy"></span></span>
                                    </div>
                                </div>
                                <div class="col-md-3 text-md-end">
                                    <button class="btn btn-success btn-lg" onclick="applyFromDetails()">
                                        <i class="bi bi-send-check"></i> Apply Now
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Content -->
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-lg-8">
                            <!-- Job Description -->
                            <div class="job-detail-card">
                                <h5><i class="bi bi-file-text me-2"></i>Job Description</h5>
                                <div id="jobDescription"></div>
                            </div>

                            <!-- Requirements -->
                            <div class="job-detail-card">
                                <h5><i class="bi bi-list-check me-2"></i>Requirements</h5>
                                <div id="jobRequirements"></div>
                            </div>

                            <!-- Benefits -->
                            <div class="job-detail-card">
                                <h5><i class="bi bi-gift me-2"></i>Benefits</h5>
                                <div id="jobBenefits"></div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-lg-4">
                            <!-- Job Information -->
                            <div class="job-detail-card">
                                <h5><i class="bi bi-info-circle me-2"></i>Job Information</h5>
                                <div class="detail-item">
                                    <span class="detail-label">Job Type:</span>
                                    <span id="infoJobType"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Experience:</span>
                                    <span id="experience"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Salary:</span>
                                    <span id="salary"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Education:</span>
                                    <span id="education"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Vacancies:</span>
                                    <span id="infoVacancies"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Apply By:</span>
                                    <span id="infoApplyBy"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Posted On:</span>
                                    <span id="postedDate"></span>
                                </div>
                            </div>

                            <!-- Company Information -->
                            <div class="job-detail-card">
                                <h5><i class="bi bi-building me-2"></i>Company Information</h5>
                                <div class="detail-item">
                                    <span class="detail-label">Company:</span>
                                    <span id="infoCompanyName"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Recruiter:</span>
                                    <span id="recruiterName"></span>
                                </div>
                            </div>

                            <!-- Apply Button -->
                            <div class="job-detail-card">
                                <h5><i class="bi bi-lightning me-2"></i>Quick Apply</h5>
                                <p>Ready to apply for this position?</p>
                                <button class="btn btn-success w-100 btn-lg" onclick="applyFromDetails()">
                                    <i class="bi bi-send-check me-2"></i>Apply Now
                                </button>
                                <div class="text-center mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i> Applications are reviewed on a rolling basis
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <div id="footer"></div>
    <!-- End Footer -->

    <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <!-- Vendor JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <!-- Template Main JS File -->
    <script src="/js/main.js"></script>

    <!-- Job Details Script -->
    <script>
        // API endpoint configuration
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:8082/'
            : 'https://login.rssi.in/';

        let currentJob = null;

        $(document).ready(function () {
            // Get job ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('id');

            if (jobId) {
                loadJobDetails(jobId);
            } else {
                showError('No job specified. Please go back to job listings.');
            }
        });

        function loadJobDetails(jobId) {
            $('#loadingContainer').show();
            $('#errorContainer').hide();
            $('#jobDetailsContainer').hide();

            $.ajax({
                url: API_BASE + 'get_job_details.php',
                type: 'GET',
                data: { id: jobId },
                dataType: 'json',
                success: function (response) {
                    $('#loadingContainer').hide();

                    if (response.success && response.data) {
                        currentJob = response.data;
                        displayJobDetails(currentJob);
                        $('#jobDetailsContainer').show();
                    } else {
                        showError(response.message || 'Job not found.');
                    }
                },
                error: function () {
                    $('#loadingContainer').hide();
                    showError('Unable to load job details. Please try again.');
                }
            });
        }

        function displayJobDetails(job) {
            // Set page title
            document.title = `${job.job_title} - RSSI Jobs`;
            $('#pageTitle').text(job.job_title);

            // Header section
            $('#jobTitle').text(job.job_title);
            $('#companyName').text(job.company_name);
            $('#jobLocation').text(job.location);
            $('#jobType').text(formatJobType(job.job_type));
            $('#vacancies').text(job.vacancies);
            $('#applyBy').text(formatDate(job.apply_by));

            // Content sections
            $('#jobDescription').html(formatText(job.job_description));
            $('#jobRequirements').html(formatText(job.requirements || 'Not specified'));
            $('#jobBenefits').html(formatText(job.benefits || 'Not specified'));

            // Information sidebar
            $('#infoJobType').text(formatJobType(job.job_type));
            $('#experience').text(job.experience ? `${job.experience} years` : 'Not specified');
            $('#salary').text(job.salary ? `â‚¹${formatNumber(job.salary)}` : 'Not specified');
            $('#education').text(job.education || 'Not specified');
            $('#infoVacancies').text(job.vacancies);
            $('#infoApplyBy').text(formatDate(job.apply_by));
            $('#postedDate').text(formatDate(job.created_at));

            // Company info
            $('#infoCompanyName').text(job.company_name);
            $('#recruiterName').text(job.recruiter_name || 'Not specified');
        }

        function applyFromDetails() {
            if (!currentJob) return;

            const phone = prompt(`Enter your phone number to apply for "${currentJob.job_title}":`);

            if (!phone || !phone.trim()) {
                alert('Phone number is required to apply.');
                return;
            }

            if (!/^\d{10}$/.test(phone)) {
                alert('Please enter a valid 10-digit phone number.');
                return;
            }

            checkUserExists(phone, currentJob.id, currentJob.job_title);
        }

        function checkUserExists(phone, jobId, jobTitle) {
            $.ajax({
                url: API_BASE + 'check_applicant.php',
                type: 'POST',
                data: {
                    phone: phone,
                    job_id: jobId
                },
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        if (response.exists) {
                            if (confirm(`Welcome back ${response.name}! Do you want to apply for "${jobTitle}"?`)) {
                                submitApplication(response.applicant_id, jobId);
                            }
                        } else {
                            // NEW USER - Show registration form directly instead of redirecting
                            showRegistrationForm(phone, jobId, jobTitle);
                        }
                    } else {
                        alert('Error: ' + (response.message || 'Unable to check user status.'));
                    }
                },
                error: function () {
                    alert('Network error. Please try again.');
                }
            });
        }

        function submitApplication(applicantId, jobId) {
            $.ajax({
                url: API_BASE + 'submit_existing_application.php',
                type: 'POST',
                data: {
                    applicant_id: applicantId,
                    job_id: jobId
                },
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        alert('Application submitted successfully!');
                        if (response.email) {
                            sendApplicationEmail(response.email, response.applicant_name, response.job_title);
                        }
                    } else {
                        alert('Error: ' + (response.message || 'Failed to submit application.'));
                    }
                },
                error: function () {
                    alert('Network error. Please try again.');
                }
            });
        }

        function sendApplicationEmail(email, name, jobTitle) {
            $.ajax({
                url: API_BASE + 'send_application_email.php',
                type: 'POST',
                data: {
                    email: email,
                    name: name,
                    job_title: jobTitle
                },
                dataType: 'json',
                success: function (response) {
                    console.log('Application email sent:', response);
                },
                error: function () {
                    console.log('Failed to send application email');
                }
            });
        }

        function showError(message) {
            $('#errorMessage').text(message);
            $('#errorContainer').show();
        }

        // Utility functions
        function formatJobType(jobType) {
            return jobType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function formatText(text) {
            if (!text) return '<em>Not specified</em>';
            return text.replace(/\n/g, '<br>');
        }

        function showRegistrationForm(phone, jobId, jobTitle) {
            $.ajax({
                url: API_BASE + 'get_education_levels.php',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success && response.data) {
                        const educationOptions = response.data.map(edu =>
                            `<option value="${edu.id}">${escapeHtml(edu.name)}</option>`
                        ).join('');

                        // Create a modal or form for registration
                        const formHtml = `
                    <div class="modal fade" id="registrationModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Apply for: ${escapeHtml(jobTitle)}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-muted">Please provide your details to complete the application.</p>
                                    
                                    <form id="registrationForm">
                                        <input type="hidden" name="phone" value="${phone}">
                                        <input type="hidden" name="job_id" value="${jobId}">
                                        
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="name" class="form-label">Full Name *</label>
                                                <input type="text" class="form-control" id="name" name="name" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="email" class="form-label">Email Address</label>
                                                <input type="email" class="form-control" id="email" name="email">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="age" class="form-label">Age *</label>
                                                <input type="number" class="form-control" id="age" name="age" min="18" max="70" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="education" class="form-label">Education Level *</label>
                                                <select class="form-select" id="education" name="education" required>
                                                    <option value="">Select Education</option>
                                                    ${educationOptions}
                                                </select>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label for="skills" class="form-label">Skills *</label>
                                                <textarea class="form-control" id="skills" name="skills" rows="3" 
                                                          placeholder="List your skills (e.g., Python, HTML, Communication)" required></textarea>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label for="preferences" class="form-label">Job Preferences</label>
                                                <textarea class="form-control" id="preferences" name="preferences" rows="2"
                                                          placeholder="Any specific preferences or requirements"></textarea>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label for="address" class="form-label">Address</label>
                                                <textarea class="form-control" id="address" name="address" rows="2"
                                                          placeholder="Your current address"></textarea>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-success" onclick="submitNewApplicationFromModal()">
                                        <i class="bi bi-send-check"></i> Submit Application
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                        // Add modal to DOM
                        $('body').append(formHtml);

                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
                        modal.show();

                        // Remove modal from DOM when hidden
                        $('#registrationModal').on('hidden.bs.modal', function () {
                            $(this).remove();
                        });
                    }
                },
                error: function () {
                    alert('Unable to load education options. Please try again.');
                }
            });
        }

        function submitNewApplicationFromModal() {
            const form = $('#registrationForm');
            const formData = new FormData(form[0]);

            $.ajax({
                url: API_BASE + 'submit_application.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        alert('Application submitted successfully! You will receive a confirmation email.');
                        $('#registrationModal').modal('hide');

                        if (response.email) {
                            sendApplicationEmail(response.email, response.applicant_name, response.job_title);
                        }
                    } else {
                        alert('Error: ' + (response.message || 'Failed to submit application.'));
                    }
                },
                error: function () {
                    alert('Network error. Please try again.');
                }
            });
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

</body>

</html>