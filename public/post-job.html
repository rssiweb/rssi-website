<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-11316670180"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'AW-11316670180');
    </script>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Recruiters’ Portal</title>
    <meta content="" name="description">
    <meta content="" name="keywords">

    <!-- Favicons -->
    <link href="/img/favicon.ico" rel="icon">
    <link href="/img/apple-touch-icon.png" rel="apple-touch-icon">

    <!-- Vendor CSS Files -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Template Main CSS File -->
    <link href="/css/main.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(function () {
            $("#header").load("/header.html");
            $("#footer").load("/footer.html");
        });
    </script>
    <!-- Add this CSS -->
    <style>
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #dee2e6;
            z-index: 1;
        }

        .step {
            position: relative;
            z-index: 2;
            background: white;
            padding: 0 15px;
            text-align: center;
            flex: 1;
        }

        .step::before {
            content: '';
            display: block;
            width: 30px;
            height: 30px;
            margin: 0 auto 10px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            line-height: 30px;
            font-weight: bold;
        }

        .step.active::before {
            background: #0d6efd;
            color: white;
        }

        .step:nth-child(1)::before {
            content: '1';
        }

        .step:nth-child(2)::before {
            content: '2';
        }

        .step:nth-child(3)::before {
            content: '3';
        }

        .step:nth-child(4)::before {
            content: '4';
        }
    </style>
    <script>
        alert('You will be redirected to the recruiters portal.');
        window.location.href = 'https://login.rssi.in/recruiters/index.php';
    </script>
</head>

<body>

    <!-- ======= Header ======= -->
    <div id="header"></div>
    <!-- End Header -->

    <main id="main">

        <!-- ======= Breadcrumbs ======= -->
        <div class="breadcrumbs">
            <div class="container">

                <div class="d-flex justify-content-between align-items-center">
                    <h2>Recruiters’ Portal</h2>
                    <ol>
                        <li><a href="index">Home</a></li>
                        <li>Careers</li>
                        <li>Recruiters’ Portal</li>
                    </ol>
                </div>

            </div>
        </div>

        <!-- End Breadcrumbs -->
        <section class="sample-page">
            <div class="container" data-aos="fade-up">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="card shadow">
                            <div class="card-body p-5">
                                <h2 class="mb-4 text-center">Recruiter Job Post Form</h2>

                                <!-- Step Indicator -->
                                <div class="mb-5">
                                    <div class="steps">
                                        <div class="step active" data-step="1">Email Verification</div>
                                        <div class="step" data-step="2">Registration/Login</div>
                                        <div class="step" data-step="3">Job Details</div>
                                        <div class="step" data-step="4">Confirmation</div>
                                    </div>
                                </div>

                                <!-- Step Container - This will hold all dynamic content -->
                                <div id="stepContainer">
                                    <!-- Content will be loaded here dynamically by JavaScript -->
                                </div>

                                <!-- Success Message -->
                                <div id="successMessage" style="display: none;">
                                    <div class="alert alert-success text-center">
                                        <h4>✅ Job Posted Successfully!</h4>
                                        <p>Your job post has been submitted and is pending approval.</p>
                                        <p>You will receive a confirmation email shortly.</p>
                                        <button type="button" class="btn btn-primary" id="postAnother">Post Another
                                            Job</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- End Gallery Section -->
    </main>
    <!-- End #main -->
    <!-- ======= Footer ======= -->
    <div id="footer"></div>
    <!-- End Footer -->

    <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <!--<div id="preloader"></div>-->

    <!-- Vendor JS Files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <!-- Template Main JS File -->
    <script src="/js/main.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/manucaralmo/GlowCookies@3.0.1/src/glowCookies.min.js"></script>
    <!-- Glow Cookies v3.0.1 -->
    <script>
        glowCookies.start('en', {
            analytics: 'G-S25QWTFJ2S',
            //facebookPixel: '',
            policyLink: 'disclaimer'
        });
    </script>

    <!-- JavaScript for Step Navigation -->
    <script>
        $(document).ready(function () {
            let currentStep = 1;
            let verifiedEmail = '';
            let otpTimer = null;
            let otpExpiryTime = null;
            let recruiterId = null;

            // API endpoint configuration
            const API_BASE = window.location.hostname === 'localhost'
                ? 'http://localhost:8082/job-api/'
                : 'https://login.rssi.in/job-api/';

            // Add this function before bindStep1Events
            function loadEducationLevels() {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: API_BASE + 'get_education_levels.php',
                        type: 'GET',
                        dataType: 'json',
                        success: function (response) {
                            if (response.success && response.data) {
                                resolve(response.data);
                            } else {
                                // Reject to trigger the catch block
                                reject(new Error('Failed to fetch education levels'));
                            }
                        },
                        error: function () {
                            reject(new Error('Network error fetching education levels'));
                        }
                    });
                });
            }

            // Step Navigation Functions
            function showStep(step) {
                // Update step indicator
                $('.step').removeClass('active');
                $(`.step[data-step="${step}"]`).addClass('active');

                currentStep = step;

                // If going back to step 1 from any other step, reset email verification
                if (step === 1 && currentStep > 1) {
                    verifiedEmail = '';
                    clearInterval(otpTimer);
                    otpTimer = null;
                    recruiterId = null; // Also reset recruiter ID if going back
                }

                // Load appropriate form
                loadStepContent(step);
            }

            function loadStepContent(step) {
                const container = $('#stepContainer');

                if (step === 1) {
                    // Email verification step - Show email input first
                    container.html(`
                <div class="step-content" id="step1">
                    <div class="mb-4">
                        <h5>Email Verification</h5>
                        <p class="text-muted mb-3">Enter your email to continue</p>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="userEmail" placeholder="Enter your email" value="${verifiedEmail || ''}">
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="backToStart" style="display: none;">Back</button>
                            <button type="button" class="btn btn-primary" id="checkEmail">Next</button>
                        </div>
                    </div>
                </div>
            `);

                    // Re-bind events for step 1
                    bindStep1Events();

                } else if (step === 2) {
                    // Registration form for new users
                    container.html(`
                <div class="step-content" id="step2">
                    <form id="registrationForm">
                        <h4 class="mb-3 border-bottom pb-2">Recruiter Registration</h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="companyName" class="form-label">Company Name *</label>
                                <input type="text" class="form-control" id="companyName" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="regEmail" value="${verifiedEmail}" readonly required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="aadharNumber" class="form-label">Aadhar Number *</label>
                                <input type="text" class="form-control" id="aadharNumber" pattern="[0-9]{12}" maxlength="12" required>
                                <div class="form-text">12-digit Aadhar number</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="aadharFile" class="form-label">Aadhar Card Upload *</label>
                                <input type="file" class="form-control" id="aadharFile" accept=".pdf,.jpg,.jpeg,.png" required>
                                <div class="form-text">Max size: 2MB (PDF, JPG, PNG)</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="companyAddress" class="form-label">Company Address *</label>
                            <textarea class="form-control" id="companyAddress" rows="3" required></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="backToStep1">Back</button>
                            <button type="button" class="btn btn-primary" id="saveRegistration">Save & Continue to Job Post</button>
                        </div>
                    </form>
                </div>
            `);

                    // Re-bind events for step 2
                    bindStep2Events();

                } else if (step === 3) {
                    // Job post form
                    container.html(`
        <div class="step-content" id="step3">
            <form id="jobPostForm">
                <h4 class="mb-3 border-bottom pb-2">Job Details</h4>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="jobTitle" class="form-label">Job Title *</label>
                        <input type="text" class="form-control" id="jobTitle" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="jobType" class="form-label">Job Type *</label>
                        <select class="form-select" id="jobType" required>
                            <option value="">Select Type</option>
                            <option value="full-time">Full Time</option>
                            <option value="part-time">Part Time</option>
                            <option value="contract">Contract</option>
                            <option value="internship">Internship</option>
                            <option value="remote">Remote</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="location" class="form-label">Location *</label>
                        <input type="text" class="form-control" id="location" required>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="minSalary" class="form-label">Min Salary (₹ per month) *</label>
                        <input type="number" class="form-control" id="minSalary" min="0" placeholder="e.g., 25000" required>
                        <div class="form-text">Minimum expected salary</div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="maxSalary" class="form-label">Max Salary (₹ per month) *</label>
                        <input type="number" class="form-control" id="maxSalary" min="0" placeholder="e.g., 50000" required>
                        <div class="form-text">Maximum expected salary</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="jobDescription" class="form-label">Job Description *</label>
                    <textarea class="form-control" id="jobDescription" rows="5" required></textarea>
                </div>

                <div class="mb-3">
                    <label for="requirements" class="form-label">Requirements *</label>
                    <textarea class="form-control" id="requirements" rows="3" required></textarea>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="experience" class="form-label">Experience Required *</label>
                        <input type="text" class="form-control" id="experience" placeholder="e.g., 2-4 years" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="educationQualification" class="form-label">Educational Qualification *</label>
                        <select class="form-select" id="educationQualification" required>
                            <option value="">Select Qualification</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <div class="form-text">Minimum education required</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="vacancies" class="form-label">Number of Vacancies *</label>
                        <input type="number" class="form-control" id="vacancies" min="1" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="applyBy" class="form-label">Apply By Date *</label>
                        <input type="date" class="form-control" id="applyBy" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="jobFile" class="form-label">Additional Document (Optional)</label>
                    <input type="file" class="form-control" id="jobFile" accept=".pdf,.doc,.docx">
                    <div class="form-text">Job description PDF or Word doc</div>
                </div>
                <div class="mb-3">
                    <label for="benefits" class="form-label">Benefits (Optional)</label>
                    <textarea class="form-control" id="benefits" name="benefits" rows="2" placeholder="e.g., Health insurance, flexible hours, etc."></textarea>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="backToStep2">Back</button>
                    <button type="submit" class="btn btn-success" id="submitJob">Submit Job Post</button>
                </div>
            </form>
        </div>
    `);

                    // Load education levels
                    loadEducationLevels().then(educationLevels => {
                        // Populate education qualification dropdown
                        const select = $('#educationQualification');
                        educationLevels.forEach(level => {
                            select.append(`<option value="${level.id}">${level.name}</option>`);
                        });
                    }).catch(error => {
                        console.error('Failed to load education levels:', error);
                        // Show error message to user
                        alert('Failed to load education levels. Please refresh the page or try again later.');
                    });

                    // Re-bind events for step 3
                    bindStep3Events();
                }
            }

            // Event binding functions
            function bindStep1Events() {
                // Check Email
                $(document).off('click', '#checkEmail').on('click', '#checkEmail', function () {
                    const email = $('#userEmail').val().trim();

                    if (!validateEmail(email)) {
                        alert('Please enter a valid email address');
                        return;
                    }

                    verifiedEmail = email;
                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Checking...');

                    // Check if email exists in database
                    $.ajax({
                        url: API_BASE + 'check_user.php', // Need to create this endpoint
                        type: 'POST',
                        data: { email: email },
                        success: function (response) {
                            console.log('Check User Response:', response);
                            if (response.success) {
                                if (response.user_exists) {
                                    if (response.has_password) {
                                        // Existing user with password - show login
                                        showPasswordLogin();
                                    } else {
                                        // Existing user without password (old record) - show registration
                                        showStep(2);
                                    }
                                } else {
                                    // New user - show OTP verification
                                    showOTPVerification();
                                }
                            } else {
                                alert(response.message || 'Error checking email');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Check User Error:', error);
                            alert('Error checking email. Please try again.');
                        },
                        complete: function () {
                            $('#checkEmail').prop('disabled', false).text('Next');
                        }
                    });
                });
            }

            function showOTPVerification() {
                $('#stepContainer').html(`
        <div class="step-content" id="step1">
            <div class="mb-4">
                <h5>Email Verification</h5>
                <p class="text-muted mb-3">We've sent an OTP to ${verifiedEmail}</p>
                <div class="mb-3">
                    <label for="userEmail" class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="userEmail" value="${verifiedEmail}" readonly>
                </div>
                <div id="otpSection">
                    <div class="mb-3">
                        <label for="otp" class="form-label">Enter OTP *</label>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control text-center" id="otp" maxlength="6" placeholder="6-digit OTP" style="width: 150px;">
                            <button type="button" class="btn btn-outline-secondary" id="resendOTP">Resend OTP</button>
                        </div>
                        <div class="form-text" id="otpTimer"></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="useDifferentEmail">Use different email address</button>
                        <button type="button" class="btn btn-primary" id="verifyOTP">Verify & Proceed</button>
                    </div>
                </div>
            </div>
        </div>
    `);

                // Bind events FIRST
                bindOTPEvents();

                // Send OTP automatically WITHOUT using a button click
                sendOTPAutomatically();
            }

            // Add this new function
            function sendOTPAutomatically() {
                // Show loading message
                $('#otpSection').prepend('<div class="alert alert-info">Sending OTP to your email...</div>');

                $.ajax({
                    url: API_BASE + 'send_otp.php',
                    type: 'POST',
                    data: { email: verifiedEmail, action: 'send_otp' },
                    success: function (response) {
                        console.log('OTP Response:', response);
                        if (response.success) {
                            // Remove loading message
                            $('#otpSection .alert').remove();

                            // Show success briefly
                            $('#otpSection').prepend('<div class="alert alert-success alert-dismissible fade show">✓ OTP sent successfully! <button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>');

                            // Start timer
                            startOTPTimer(300);

                            // Auto-dismiss success after 3 seconds
                            setTimeout(() => {
                                $('.alert-success').alert('close');
                            }, 3000);
                        } else {
                            $('#otpSection .alert').remove();
                            $('#otpSection').prepend('<div class="alert alert-danger">Failed to send OTP: ' + (response.message || 'Unknown error') + '</div>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('OTP Error:', error);
                        $('#otpSection .alert').remove();
                        $('#otpSection').prepend('<div class="alert alert-danger">Error sending OTP. Please try the Resend button.</div>');
                    }
                });
            }

            function bindOTPEvents() {
                // Clear existing handlers
                $('#resendOTP, #verifyOTP, #useDifferentEmail').off('click');

                // Resend OTP
                $('#resendOTP').on('click', function () {
                    const $btn = $(this);
                    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sending...');

                    $.ajax({
                        url: API_BASE + 'send_otp.php',
                        type: 'POST',
                        data: { email: verifiedEmail, action: 'send_otp' },
                        success: function (response) {
                            if (response.success) {
                                // Restart timer
                                startOTPTimer(300);
                                alert('New OTP sent to your email!');
                            } else {
                                alert(response.message || 'Failed to resend OTP');
                            }
                        },
                        error: function () {
                            alert('Error resending OTP. Please try again.');
                        },
                        complete: function () {
                            $btn.prop('disabled', false).text('Resend OTP');
                        }
                    });
                });

                // Verify OTP
                $('#verifyOTP').on('click', function () {
                    const $btn = $(this);
                    const otp = $('#otp').val().trim();

                    if (otp.length !== 6) {
                        alert('Please enter a valid 6-digit OTP');
                        return;
                    }

                    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Verifying...');

                    $.ajax({
                        url: API_BASE + 'verify_otp.php',
                        type: 'POST',
                        data: { email: verifiedEmail, otp: otp, action: 'verify_otp' },
                        success: function (response) {
                            if (response.success) {
                                clearInterval(otpTimer);
                                $('#otpTimer').text('');
                                showStep(2);
                            } else {
                                alert(response.message || 'Invalid OTP');
                            }
                        },
                        error: function () {
                            alert('Error verifying OTP. Please try again.');
                        },
                        complete: function () {
                            $btn.prop('disabled', false).text('Verify & Proceed');
                        }
                    });
                });

                // Use different email
                $('#useDifferentEmail').on('click', function () {
                    if (confirm('Do you want to use a different email address? This will reset the verification process.')) {
                        verifiedEmail = '';
                        clearInterval(otpTimer);
                        otpTimer = null;
                        showStep(1);
                    }
                });

                // Resend OTP
                $(document).off('click', '#resendOTP').on('click', '#resendOTP', function () {
                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sending...');

                    $.ajax({
                        url: API_BASE + 'send_otp.php',
                        type: 'POST',
                        data: { email: verifiedEmail, action: 'send_otp' },
                        success: function (response) {
                            console.log('Resend OTP Response:', response);
                            if (response.success) {
                                startOTPTimer(300);
                                alert('New OTP sent to your email!');
                            } else {
                                alert(response.message || 'Failed to resend OTP');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Resend OTP Error:', error);
                            alert('Error resending OTP. Please try again.');
                        },
                        complete: function () {
                            $('#resendOTP').prop('disabled', false).text('Resend OTP');
                        }
                    });
                });
            }

            function showPasswordLogin() {
                $('#stepContainer').html(`
            <div class="step-content" id="passwordLogin">
                <div class="mb-4">
                    <h5>Welcome Back!</h5>
                    <p class="text-muted mb-3">Please enter your password to continue</p>
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="userEmail" value="${verifiedEmail}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password">
                    </div>
                    <div class="mb-3 text-end">
                        <a href="#" id="forgotPasswordLink" class="text-decoration-none">Forgot Password?</a>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="useDifferentEmailLogin">Use different email address</button>
                        <button type="button" class="btn btn-primary" id="loginWithPassword">Login</button>
                    </div>
                </div>
            </div>
        `);

                // Bind events
                $('#loginWithPassword').click(function () {
                    const password = $('#password').val().trim();

                    if (!password) {
                        alert('Please enter your password');
                        return;
                    }

                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Logging in...');

                    $.ajax({
                        url: API_BASE + 'login.php',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            email: verifiedEmail,
                            password: password
                        }),
                        success: function (response) {
                            if (response.success) {
                                if (response.requires_password_change) {
                                    showChangePasswordForm();
                                } else {
                                    showStep(3); // Proceed to job post
                                }
                            } else {
                                alert(response.message || 'Login failed');
                            }
                        },
                        error: function () {
                            alert('Error during login. Please try again.');
                        },
                        complete: function () {
                            $('#loginWithPassword').prop('disabled', false).text('Login');
                        }
                    });
                });

                $('#forgotPasswordLink').click(function (e) {
                    e.preventDefault();
                    showForgotPasswordForm();
                });

                $('#useDifferentEmailLogin').click(function () {
                    if (confirm('Do you want to use a different email address?')) {
                        verifiedEmail = '';
                        showStep(1);
                    }
                });
            }

            function bindStep2Events() {
                // Save Registration
                $(document).off('click', '#saveRegistration').on('click', '#saveRegistration', function () {
                    if (!validateRegistrationForm()) {
                        return;
                    }

                    const formData = new FormData();
                    formData.append('email', verifiedEmail);
                    formData.append('full_name', $('#fullName').val());
                    formData.append('company_name', $('#companyName').val());
                    formData.append('phone', $('#phone').val());
                    formData.append('aadhar_number', $('#aadharNumber').val());
                    formData.append('company_address', $('#companyAddress').val());

                    const aadharFile = $('#aadharFile')[0].files[0];
                    if (aadharFile) {
                        formData.append('aadhar_file', aadharFile);
                    }

                    formData.append('action', 'register');

                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Saving...');

                    $.ajax({
                        url: API_BASE + 'register.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: 'json',
                        success: function (response) {
                            console.log('Registration Response:', response);
                            if (response.success) {
                                recruiterId = response.recruiter_id;
                                showStep(3);
                            } else {
                                alert(response.message || 'Registration failed');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Registration Error:', error);
                            let errorMsg = 'Error saving registration. Please try again.';
                            if (xhr.responseText) {
                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    if (errorResponse.message) errorMsg = errorResponse.message;
                                } catch (e) { }
                            }
                            alert(errorMsg);
                        },
                        complete: function () {
                            $('#saveRegistration').prop('disabled', false).text('Save & Continue to Job Post');
                        }
                    });
                });

                // Back to step 1
                $(document).off('click', '#backToStep1').on('click', '#backToStep1', function () {
                    verifiedEmail = '';
                    clearInterval(otpTimer);
                    otpTimer = null;
                    showStep(1);
                });
            }

            function bindStep3Events() {
                // Submit Job
                $(document).off('submit', '#jobPostForm').on('submit', '#jobPostForm', function (e) {
                    e.preventDefault();

                    if (!validateJobForm()) {
                        return;
                    }

                    const formData = new FormData();
                    formData.append('email', verifiedEmail);
                    formData.append('job_title', $('#jobTitle').val());
                    formData.append('job_type', $('#jobType').val());
                    formData.append('location', $('#location').val());
                    formData.append('min_salary', $('#minSalary').val());
                    formData.append('max_salary', $('#maxSalary').val());
                    formData.append('job_description', $('#jobDescription').val());
                    formData.append('requirements', $('#requirements').val());
                    formData.append('experience', $('#experience').val());
                    formData.append('education_qualification', $('#educationQualification').val()); // Add this line
                    formData.append('vacancies', $('#vacancies').val());
                    formData.append('apply_by', $('#applyBy').val());
                    formData.append('benefits', $('#benefits').val());

                    const jobFile = $('#jobFile')[0].files[0];
                    if (jobFile) {
                        formData.append('job_file', jobFile);
                    }

                    formData.append('action', 'post_job');

                    $('#submitJob').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Submitting...');

                    $.ajax({
                        url: API_BASE + 'post_job.php',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        dataType: 'json',
                        success: function (response) {
                            console.log('Job Post Response:', response);
                            if (response.success) {
                                // Update step indicator to show step 4 as active
                                $('.step').removeClass('active');
                                $(`.step[data-step="4"]`).addClass('active');
                                $('#stepContainer').hide();
                                $('#successMessage').show();
                            } else {
                                alert(response.message || 'Job posting failed');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Job Post Error:', error);
                            let errorMsg = 'Error submitting job. Please try again.';
                            if (xhr.responseText) {
                                try {
                                    const errorResponse = JSON.parse(xhr.responseText);
                                    if (errorResponse.message) errorMsg = errorResponse.message;
                                } catch (e) { }
                            }
                            alert(errorMsg);
                        },
                        complete: function () {
                            $('#submitJob').prop('disabled', false).text('Submit Job Post');
                        }
                    });
                });

                // Back to step 2 or 1
                $(document).off('click', '#backToStep2').on('click', '#backToStep2', function () {
                    if (recruiterId) {
                        showStep(2);
                    } else {
                        verifiedEmail = '';
                        clearInterval(otpTimer);
                        otpTimer = null;
                        showStep(1);
                    }
                });
            }

            // Add function for change password form
            function showChangePasswordForm() {
                $('#stepContainer').html(`
            <div class="step-content" id="changePassword">
                <div class="mb-4">
                    <h5>Change Default Password</h5>
                    <p class="text-muted mb-3">Please change your default password for security</p>
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password *</label>
                        <input type="password" class="form-control" id="currentPassword" placeholder="Enter current password">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password *</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="Enter new password">
                        <div class="form-text">Minimum 8 characters</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password *</label>
                        <input type="password" class="form-control" id="confirmPassword" placeholder="Confirm new password">
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" id="backToLogin">Back to Login</button>
                        <button type="button" class="btn btn-primary" id="changePasswordBtn">Change Password</button>
                    </div>
                </div>
            </div>
        `);

                // Bind events
                $('#changePasswordBtn').click(function () {
                    const currentPassword = $('#currentPassword').val().trim();
                    const newPassword = $('#newPassword').val().trim();
                    const confirmPassword = $('#confirmPassword').val().trim();

                    if (!currentPassword || !newPassword || !confirmPassword) {
                        alert('All fields are required');
                        return;
                    }

                    if (newPassword.length < 8) {
                        alert('New password must be at least 8 characters long');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        alert('New passwords do not match');
                        return;
                    }

                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Changing...');

                    $.ajax({
                        url: API_BASE + 'change_password.php',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            email: verifiedEmail,
                            current_password: currentPassword,
                            new_password: newPassword
                        }),
                        success: function (response) {
                            if (response.success) {
                                alert('Password changed successfully!');
                                showStep(3); // Proceed to job post
                            } else {
                                alert(response.message || 'Failed to change password');
                            }
                        },
                        error: function () {
                            alert('Error changing password. Please try again.');
                        },
                        complete: function () {
                            $('#changePasswordBtn').prop('disabled', false).text('Change Password');
                        }
                    });
                });

                $('#backToLogin').click(function () {
                    showPasswordLogin();
                });
            }

            // Add function for forgot password
            function showForgotPasswordForm() {
                $('#stepContainer').html(`
            <div class="step-content" id="forgotPassword">
                <div class="mb-4">
                    <h5>Reset Password</h5>
                    <p class="text-muted mb-3">We'll send an OTP to your email to reset your password</p>
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Email Address *</label>
                        <input type="email" class="form-control" id="resetEmail" value="${verifiedEmail}" readonly>
                    </div>
                    <button type="button" class="btn btn-primary" id="sendResetOTP">Send OTP</button>
                    
                    <div id="resetOtpSection" style="display: none;" class="mt-3">
                        <div class="mb-3">
                            <label for="resetOtp" class="form-label">Enter OTP *</label>
                            <input type="text" class="form-control text-center" id="resetOtp" maxlength="6" placeholder="6-digit OTP">
                        </div>
                        <div class="mb-3">
                            <label for="newResetPassword" class="form-label">New Password *</label>
                            <input type="password" class="form-control" id="newResetPassword" placeholder="Enter new password">
                        </div>
                        <div class="mb-3">
                            <label for="confirmResetPassword" class="form-label">Confirm New Password *</label>
                            <input type="password" class="form-control" id="confirmResetPassword" placeholder="Confirm new password">
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="backToPasswordLogin">Back to Login</button>
                            <button type="button" class="btn btn-success" id="resetPasswordBtn">Reset Password</button>
                        </div>
                    </div>
                </div>
            </div>
        `);

                // Bind events
                $('#sendResetOTP').click(function () {
                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Sending...');

                    $.ajax({
                        url: API_BASE + 'reset_password.php',
                        type: 'POST',
                        data: {
                            email: verifiedEmail,
                            action: 'request_reset'
                        },
                        success: function (response) {
                            if (response.success) {
                                $('#resetOtpSection').show();
                                alert('OTP sent to your email');
                            } else {
                                alert(response.message || 'Failed to send OTP');
                            }
                        },
                        error: function () {
                            alert('Error sending OTP. Please try again.');
                        },
                        complete: function () {
                            $('#sendResetOTP').prop('disabled', false).text('Send OTP');
                        }
                    });
                });

                $('#resetPasswordBtn').click(function () {
                    const otp = $('#resetOtp').val().trim();
                    const newPassword = $('#newResetPassword').val().trim();
                    const confirmPassword = $('#confirmResetPassword').val().trim();

                    if (!otp || !newPassword || !confirmPassword) {
                        alert('All fields are required');
                        return;
                    }

                    if (newPassword.length < 8) {
                        alert('Password must be at least 8 characters long');
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        alert('Passwords do not match');
                        return;
                    }

                    $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Resetting...');

                    $.ajax({
                        url: API_BASE + 'reset_password.php',
                        type: 'POST',
                        data: {
                            email: verifiedEmail,
                            otp: otp,
                            new_password: newPassword,
                            action: 'verify_and_reset'
                        },
                        success: function (response) {
                            if (response.success) {
                                alert('Password reset successfully! Please login with your new password.');
                                showPasswordLogin();
                            } else {
                                alert(response.message || 'Failed to reset password');
                            }
                        },
                        error: function () {
                            alert('Error resetting password. Please try again.');
                        },
                        complete: function () {
                            $('#resetPasswordBtn').prop('disabled', false).text('Reset Password');
                        }
                    });
                });

                $('#backToPasswordLogin').click(function () {
                    showPasswordLogin();
                });
            }

            // Post Another Job
            $('#postAnother').click(function () {
                location.reload();
            });

            // Start OTP Timer
            function startOTPTimer(seconds) {
                clearInterval(otpTimer);
                otpExpiryTime = new Date().getTime() + (seconds * 1000);

                otpTimer = setInterval(function () {
                    const now = new Date().getTime();
                    const distance = otpExpiryTime - now;

                    if (distance <= 0) {
                        clearInterval(otpTimer);
                        $('#otpTimer').html('<span class="text-danger">OTP expired. Please request a new one.</span>');
                        $('#otp').prop('disabled', true);
                    } else {
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        $('#otpTimer').text(`OTP expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`);
                    }
                }, 1000);
            }

            // Validation Functions
            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            function validateRegistrationForm() {
                if (!$('#fullName').val().trim()) {
                    alert('Full name is required');
                    return false;
                }
                if (!$('#companyName').val().trim()) {
                    alert('Company name is required');
                    return false;
                }
                if (!$('#phone').val().trim()) {
                    alert('Phone number is required');
                    return false;
                }
                if (!$('#aadharNumber').val().trim() || !/^[0-9]{12}$/.test($('#aadharNumber').val())) {
                    alert('Valid 12-digit Aadhar number is required');
                    return false;
                }
                if (!$('#companyAddress').val().trim()) {
                    alert('Company address is required');
                    return false;
                }
                if (!$('#aadharFile')[0].files[0]) {
                    alert('Aadhar file is required');
                    return false;
                }
                return true;
            }

            function validateJobForm() {
                if (!$('#jobTitle').val().trim()) {
                    alert('Job title is required');
                    return false;
                }
                if (!$('#jobType').val()) {
                    alert('Job type is required');
                    return false;
                }
                if (!$('#location').val().trim()) {
                    alert('Location is required');
                    return false;
                }
                if (!$('#jobDescription').val().trim()) {
                    alert('Job description is required');
                    return false;
                }
                if (!$('#requirements').val().trim()) {
                    alert('Requirements are required');
                    return false;
                }
                if (!$('#vacancies').val() || $('#vacancies').val() < 1) {
                    alert('Valid number of vacancies is required');
                    return false;
                }
                if (!$('#applyBy').val()) {
                    alert('Apply by date is required');
                    return false;
                }
                // Salary validation (optional fields, but if filled, must be valid)
                const minSalary = $('#minSalary').val();
                const maxSalary = $('#maxSalary').val();

                if (minSalary || maxSalary) {
                    // If either is filled, both must be numbers
                    if (minSalary && isNaN(minSalary)) {
                        alert('Minimum salary must be a number');
                        return false;
                    }
                    if (maxSalary && isNaN(maxSalary)) {
                        alert('Maximum salary must be a number');
                        return false;
                    }

                    // If both are filled, max must be greater than or equal to min
                    if (minSalary && maxSalary && parseInt(maxSalary) < parseInt(minSalary)) {
                        alert('Maximum salary must be greater than or equal to minimum salary');
                        return false;
                    }

                    // Ensure non-negative values
                    if (minSalary && parseInt(minSalary) < 0) {
                        alert('Minimum salary cannot be negative');
                        return false;
                    }
                    if (maxSalary && parseInt(maxSalary) < 0) {
                        alert('Maximum salary cannot be negative');
                        return false;
                    }
                }
                return true;
            }

            // Initialize
            showStep(1);
        });
    </script>
    <script>
        // Add this in your bindStep3Events() or after the form is loaded
        $(document).on('input', '#minSalary, #maxSalary', function () {
            const minSalary = $('#minSalary').val();
            const maxSalary = $('#maxSalary').val();

            if (minSalary && maxSalary && parseInt(maxSalary) < parseInt(minSalary)) {
                $(this).addClass('is-invalid');
                $(this).next('.invalid-feedback').remove();
                $(this).after('<div class="invalid-feedback">Max salary must be ≥ min salary</div>');
            } else {
                $(this).removeClass('is-invalid');
                $(this).next('.invalid-feedback').remove();
            }
        });
    </script>
</body>

</html>