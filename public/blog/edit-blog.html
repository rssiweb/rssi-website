<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Blog Post - RSSI NGO</title>
    <!-- Favicons -->
    <link href="/img/favicon.ico" rel="icon">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Template Main CSS File -->
    <link href="css/main.css" rel="stylesheet">
    <!-- Summernote WYSIWYG Editor -->
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">

    <!-- Add this in your HTML head -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            position: relative;
            min-height: 100vh;
        }

        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .form-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
            margin-bottom: 30px;
        }

        .required-field::after {
            content: " *";
            color: #e74c3c;
        }

        .form-section {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .image-preview-container {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-preview-container:hover {
            border-color: var(--secondary-color);
            background: #f0f7ff;
        }

        .image-preview {
            max-width: 100%;
            max-height: 100%;
            display: none;
            object-fit: contain;
        }

        .author-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--secondary-color);
            cursor: pointer;
        }

        .author-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tag-badge {
            display: inline-block;
            background: #e3f2fd;
            color: var(--secondary-color);
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9rem;
        }

        .tag-badge .remove-tag {
            margin-left: 8px;
            cursor: pointer;
            color: #666;
        }

        .tag-badge .remove-tag:hover {
            color: #e74c3c;
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 12px 40px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-right: 10px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .status-badge.active {
            border-color: var(--secondary-color);
        }

        .status-draft {
            background: #f8f9fa;
            color: #6c757d;
        }

        .status-published {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .alert-message {
            display: none;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* Fixed loading overlay that covers entire screen */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }

        /* Success modal */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100000;
        }

        .success-modal.show {
            display: flex;
        }

        .success-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .success-icon {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 20px;
        }

        .success-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        /* Login Required Section */
        .login-required {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 70vh;
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .login-content {
            max-width: 500px;
            padding: 40px;
        }

        .login-content i {
            font-size: 4rem;
            color: #3498db;
            margin-bottom: 20px;
        }

        #loginArea {
            display: block !important;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid #3498db;
        }

        /* Warning for non-draft posts */
        .edit-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .edit-warning i {
            color: #f39c12;
        }
    </style>
</head>

<body>
    <!-- Header will be loaded here -->
    <div id="header"></div>

    <!-- Login Required Section (shown when not logged in) -->
    <div id="loginRequired" class="login-required" style="display: none;">
        <div class="login-content">
            <i class="fas fa-lock fa-4x text-primary mb-4"></i>
            <h3>Login Required</h3>
            <p class="mb-4">Please login with Google to edit blog posts. You can only edit posts that you have created.
            </p>
            <div id="loginPortalButtons" class="mt-4 d-flex justify-content-center">
                <!-- Google button will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Fixed Loading Overlay (covers entire screen) -->
    <div class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border loading-spinner" role="status" style="width: 80px; height: 80px;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Processing your request...</h4>
            <p>Do not refresh or close this window</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="success-modal" id="successModal">
        <div class="success-content">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3>Success!</h3>
            <p id="successModalMessage">Your blog post has been updated successfully.</p>
            <div class="success-buttons">
                <button class="btn btn-outline-secondary" id="editAgainBtn">
                    <i class="fas fa-edit me-2"></i>Edit Again
                </button>
                <!-- <button class="btn btn-primary" id="viewPostBtn">
                    <i class="fas fa-eye me-2"></i>View Post
                </button> -->
                <button class="btn btn-success" id="dashboardBtn">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Main Form Container -->
    <div class="container my-5">
        <div class="form-container">
            <!-- Form Header -->
            <div class="form-header">
                <h1 class="display-5 fw-bold mb-3"><i class="fas fa-edit me-3"></i>Edit Blog Post</h1>
                <p class="lead mb-0">Update your post content and information</p>
            </div>

            <!-- Warning for non-draft posts -->
            <div class="edit-warning" id="editWarning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="warningMessage"></span>
            </div>

            <!-- Alert Messages -->
            <div class="alert alert-success alert-message" id="successAlert">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage">Blog post updated successfully!</span>
            </div>

            <div class="alert alert-danger alert-message" id="errorAlert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorMessage">Error updating blog post. Please try again.</span>
            </div>

            <!-- Blog Form -->
            <form id="blogForm">
                <input type="hidden" id="postId" value="">
                <input type="hidden" id="originalStatus" value="">

                <!-- Basic Information Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Basic Information</h3>

                    <div class="row">
                        <div class="col-md-8">
                            <!-- Title -->
                            <div class="mb-4">
                                <label for="title" class="form-label required-field fw-semibold">Post Title</label>
                                <input type="text" class="form-control form-control-lg" id="title"
                                    placeholder="Enter a compelling title for your post" required>
                                <div class="form-text">Keep it clear, concise, and engaging</div>
                            </div>

                            <!-- Slug (with generate button and validation) -->
                            <div class="mb-4">
                                <label for="slug" class="form-label fw-semibold">URL Slug</label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">/blog/</span>
                                    <input type="text" class="form-control" id="slug" placeholder="auto-generated-slug">
                                    <button class="btn btn-outline-secondary" type="button" id="generateSlugBtn">
                                        <i class="fas fa-magic me-1"></i> Generate
                                    </button>
                                </div>

                                <!-- Slug status indicator -->
                                <!-- <div id="slugStatus" class="d-none">
                                    <div class="d-flex align-items-center mt-1">
                                        <i class="fas me-2" id="slugStatusIcon"></i>
                                        <small id="slugStatusText"></small>
                                    </div>
                                </div> -->

                                <!-- Slug availability indicator -->
                                <div id="slugAvailability" class="d-none mt-2">
                                    <div class="alert alert-sm mb-0 p-2" id="slugAvailabilityAlert">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            <span>Checking availability...</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-text">Click "Generate" to create a URL-friendly slug, or customize it
                                    manually</div>
                            </div>

                            <!-- Excerpt -->
                            <div class="mb-4">
                                <label for="excerpt" class="form-label fw-semibold">Short Excerpt</label>
                                <textarea class="form-control" id="excerpt" rows="3"
                                    placeholder="Brief summary of your post (appears in listings)"></textarea>
                                <div class="form-text">Keep it under 200 characters for best results</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <!-- Featured Image -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Featured Image</label>
                                <div class="image-preview-container" id="imagePreviewContainer">
                                    <div class="text-center" id="imagePlaceholder">
                                        <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                        <p class="text-muted mb-0">Click to upload image</p>
                                        <small class="text-muted">Recommended: 1200×630 pixels</small>
                                    </div>
                                    <img src="" class="image-preview" id="imagePreview" alt="Preview">
                                </div>
                                <input type="file" class="form-control mt-2" id="featuredImage" accept="image/*"
                                    style="display: none;">
                                <input type="hidden" id="featuredImageUrl">
                                <div class="d-flex justify-content-between mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary"
                                        id="uploadFeaturedBtn">
                                        <i class="fas fa-upload me-1"></i> Upload
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="removeImage">
                                        <i class="fas fa-trash me-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Content</h3>

                    <!-- Content Editor -->
                    <div class="mb-4">
                        <label for="content" class="form-label required-field fw-semibold">Post Content</label>
                        <textarea id="content" class="form-control"></textarea>
                    </div>

                    <!-- Reading Time (auto-calculated) -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Reading Time</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="readingTime" min="1" value="5">
                                    <span class="input-group-text">minutes</span>
                                </div>
                                <div class="form-text">Estimated reading time for visitors</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categorization Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Categorization</h3>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-4">
                                <label for="category" class="form-label required-field fw-semibold">Category</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select a category</option>
                                    <!-- Categories will be loaded here dynamically -->
                                </select>
                                <div class="form-text">Choose the most relevant category</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <!-- Tags -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Tags</label>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="tagInput"
                                        placeholder="Add tags (press Enter)">
                                    <button class="btn btn-outline-secondary" type="button" id="addTagBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="form-text">Press Enter or click + to add tags</div>

                                <!-- Tags Container -->
                                <div class="mt-3" id="tagsContainer">
                                    <!-- Tags will appear here -->
                                </div>

                                <!-- Popular Tags Suggestion -->
                                <div class="mt-3">
                                    <small class="text-muted me-2">Popular tags:</small>
                                    <small>
                                        <a href="#" class="text-decoration-none me-2 tag-suggestion"
                                            data-tag="ngo">ngo</a>
                                        <a href="#" class="text-decoration-none me-2 tag-suggestion"
                                            data-tag="social-work">social-work</a>
                                        <a href="#" class="text-decoration-none me-2 tag-suggestion"
                                            data-tag="community">community</a>
                                        <a href="#" class="text-decoration-none me-2 tag-suggestion"
                                            data-tag="development">development</a>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Author & Status Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Author Information</h3>

                    <div class="row">
                        <div class="col-md-12">
                            <!-- Author Information -->
                            <div class="mb-4">
                                <div class="card">
                                    <div class="card-body">
                                        <!-- <h6 class="card-title mb-3">
                                            <i class="fas fa-user-circle me-2"></i>Author Information
                                        </h6> -->

                                        <div class="d-flex align-items-center mb-3">
                                            <div class="author-avatar-preview me-3" id="authorAvatarPreview">
                                                <div
                                                    class="bg-secondary text-white w-100 h-100 d-flex align-items-center justify-content-center rounded-circle">
                                                    <i class="fas fa-user fa-2x"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div>
                                                        <h5 class="mb-1" id="authorNameDisplay">Loading...</h5>
                                                        <p class="mb-0 text-muted" id="authorEmailDisplay">Loading
                                                            email...</p>
                                                    </div>
                                                    <span class="badge bg-info">
                                                        <i class="fa-brands fa-google me-1"></i>Google Account
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="alert alert-light border mb-0">
                                            <div class="d-flex align-items-start">
                                                <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                                                <div>
                                                    <small class="text-muted">
                                                        Your author information is linked to your Google account.
                                                        To update your name or profile photo, please update your Google
                                                        account settings.
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex justify-content-between pt-4 border-top">
                    <div>
                        <button type="button" class="btn btn-outline-secondary" id="previewBtn">
                            <i class="fas fa-eye me-2"></i> Preview
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="cancelBtn">
                            <i class="fas fa-times me-2"></i> Cancel
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-primary" id="saveDraftBtn">
                            <i class="fas fa-save me-2"></i> Save Draft
                        </button>
                        <button type="submit" class="btn btn-submit ms-2" id="submitBtn">
                            <i class="fas fa-paper-plane me-2"></i> Submit for Review
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <!-- Include header script -->
    <script src="includes/header.js?v=1.2.0"></script>
    <script src="js/auth.js?v=1.2.0"></script>
    <script src="js/main.js"></script>

    <script>
        // Blog variables - ONLY page-specific variables
        let tags = [];
        let featuredImageBase64 = null;
        let postId = null;
        let originalStatus = '';
        let originalSlug = '';
        let summernoteInitialized = false;

        $(document).ready(function () {
            // Get post ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            postId = urlParams.get('id');

            if (!postId) {
                showError('No post ID specified');
                setTimeout(() => {
                    window.location.href = 'user-portal.html';
                }, 2000);
                return;
            }

            // Check login status and handle page state
            handlePageState();
        });

        // ==================== PAGE STATE MANAGEMENT ====================

        function handlePageState() {
            // Check if user is logged in (using centralized auth.js)
            if (checkUserLogin()) {
                // User is logged in, show dashboard and load post
                showEditorPage();
                loadPostData(postId);
                if (!summernoteInitialized) {
                    initializeSummernote();
                    setupEventListeners();
                    summernoteInitialized = true;
                }
            } else {
                // User not logged in, show login required
                showLoginRequired();
                if (summernoteInitialized) {
                    // Destroy summernote if it was initialized
                    $('#content').summernote('destroy');
                    summernoteInitialized = false;
                }
            }
        }

        function showEditorPage() {
            $('#loginRequired').hide();
            $('.form-container').show();
            initializeForm();

            // Load categories from API
            loadCategories();

            if (!summernoteInitialized) {
                initializeSummernote();
                setupEventListeners();
                summernoteInitialized = true;
            }
        }

        function showLoginRequired() {
            $('#loginRequired').show();
            $('.form-container').hide();

            // Render Google button in login required section
            createGoogleSignInButton('loginPortalButtons');
        }

        function loadPostData(postId) {
            if (!currentUser || !postId) return;

            showLoading(true);

            $.ajax({
                url: API_BASE + 'get_post.php?id=' + postId + '&user_id=' + currentUser.id,
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        populateForm(response.post);
                    } else {
                        showError(response.message || 'Failed to load post');
                        setTimeout(() => {
                            window.location.href = 'user-portal.html';
                        }, 2000);
                    }
                    showLoading(false);
                },
                error: function (xhr, status, error) {
                    console.error('Load error:', error);
                    showError('Error loading post: ' + error);
                    showLoading(false);
                    setTimeout(() => {
                        window.location.href = 'user-portal.html';
                    }, 2000);
                }
            });
        }

        function populateForm(post) {
            // Check if user owns this post
            if (post.author_email !== currentUser.email) {
                showError('You do not have permission to edit this post');
                setTimeout(() => {
                    window.location.href = 'user-portal.html';
                }, 2000);
                return;
            }

            // Store original data
            originalStatus = post.status;
            originalSlug = post.slug;

            // Populate basic fields
            $('#postId').val(post.id);
            $('#title').val(post.title);
            $('#slug').val(post.slug);
            $('#excerpt').val(post.excerpt || '');
            // Store the selected category for later selection
            window.selectedCategory = post.category;

            // Load categories AFTER storing the selected one
            loadCategories();
            $('#readingTime').val(post.reading_time || 5);

            // Populate author display fields
            $('#authorNameDisplay').text(post.author_name || currentUser.name || 'Not available');
            $('#authorEmailDisplay').text(post.author_email || currentUser.email || 'Not available');

            // Populate tags
            if (post.tags && post.tags.length > 0) {
                tags = post.tags;
                renderTags();
            }

            // Check if post is pending - if yes, disable form immediately
            if (originalStatus !== 'draft') {
                console.log('Post is pending, disabling form...');
                disableFormForPending();
                showEditWarning('pending');
            } else {
                // Enable form for non-pending posts
                enableForm(true);
            }

            // Populate featured image if exists
            if (post.featured_image) {
                $('#imagePreview').attr('src', post.featured_image).show();
                $('#imagePlaceholder').hide();
                $('#featuredImageUrl').val(post.featured_image);
            }

            // Populate author photo if exists
            if (currentUser.picture) {
                $('#authorAvatarPreview').html(`<img src="${currentUser.picture}" class="w-100 h-100" style="object-fit: cover;">`);
            }

            // Populate content in Summernote
            $('#content').summernote('code', post.content);

            // Calculate reading time
            calculateReadingTime();
        }

        function showEditWarning(status) {
            const $warning = $('#editWarning');
            let message = '';

            switch (status) {
                case 'published':
                    message = 'This post is already published. Editing will create a new revision.';
                    break;
                case 'pending':
                    message = 'This post is pending review and cannot be edited. Please wait for admin approval or contact support.';
                    break;
                default:
                    return;
            }

            $('#warningMessage').text(message);
            $warning.show();
        }

        function disableFormForPending() {
            console.log('Disabling form for pending post');

            // Disable all form elements
            enableForm(false);

            // Remove all event listeners from action buttons
            $('#previewBtn').off('click');
            $('#cancelBtn').off('click');
            $('#saveDraftBtn').off('click');
            $('#submitBtn').off('click');

            // Disable form submission
            $('#blogForm').off('submit');

            // Style buttons to show they're disabled
            $('#previewBtn, #cancelBtn, #saveDraftBtn, #submitBtn')
                .prop('disabled', true)
                .css({
                    'opacity': '0.5',
                    'cursor': 'not-allowed'
                });

            // Show a clear message
            $('#submitBtn')
                .html('<i class="fas fa-lock me-2"></i> Editing Locked (Under Review)')
                .removeClass('btn-submit')
                .addClass('btn-secondary');

            // Add a visual indicator on the form
            $('.form-container').css('position', 'relative');

            // Remove any existing remove-tag event handlers
            $('.remove-tag').off('click');

            // Disable tag removal
            $('.remove-tag').css({
                'pointer-events': 'none',
                'opacity': '0.5',
                'cursor': 'not-allowed'
            }).html('<i class="fas fa-times"></i>');

            // Disable popular tags suggestions
            $('.tag-suggestion')
                .css({
                    'pointer-events': 'none',
                    'opacity': '0.5',
                    'cursor': 'not-allowed',
                    'text-decoration': 'none',
                    'color': '#6c757d'
                })
                .off('click');

            // Disable tag input and button
            $('#tagInput')
                .prop('disabled', true)
                .attr('placeholder', 'Tags disabled - post under review')
                .css('opacity', '0.5');

            $('#addTagBtn')
                .prop('disabled', true)
                .css('opacity', '0.5');

            // Disable all other clickable elements
            $('.image-preview-container').off('click');
            $('#uploadFeaturedBtn').off('click').prop('disabled', true).css('opacity', '0.5');
            $('#removeImage').off('click').prop('disabled', true).css('opacity', '0.5');
            $('#tagInput').off('keypress');
            $('#addTagBtn').off('click');
            $('.tag-suggestion').off('click');

            // Also disable Summernote toolbar buttons if any
            $('.note-toolbar button').prop('disabled', true).css('opacity', '0.5');
            $('.note-editable').prop('contenteditable', 'false');
        }

        function initializeForm() {
            // Only run form initialization when user is logged in
            if (currentUser) {

                // Enable form (but check if it's pending)
                if (originalStatus !== 'pending') {
                    enableForm(true);
                }
            }
        }

        function initializeSummernote() {
            if ($('#content').length && !summernoteInitialized) {
                $('#content').summernote({
                    height: 400,
                    toolbar: [
                        ['style', ['style']],
                        ['font', ['bold', 'italic', 'underline', 'clear']],
                        ['fontname', ['fontname']],
                        ['color', ['color']],
                        ['para', ['ul', 'ol', 'paragraph']],
                        ['height', ['height']],
                        ['table', ['table']],
                        ['insert', ['link', 'picture', 'video', 'hr']],
                        ['view', ['fullscreen', 'codeview', 'help']]
                    ],
                    placeholder: 'Write your amazing content here...',
                    callbacks: {
                        onChange: function (contents) {
                            calculateReadingTime();
                        },
                        onImageUpload: function (files) {
                            const file = files[0];
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                $('#content').summernote('insertImage', e.target.result);
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                });
                summernoteInitialized = true;
            }
        }

        function enableForm(enabled) {
            const form = $('#blogForm');
            const formElements = form.find('input, select, textarea, button');

            if (enabled) {
                // Enable all form elements
                formElements.prop('disabled', false);

                // Enable Summernote editor
                if ($('#content').summernote) {
                    $('#content').summernote('enable');
                    $('.note-editable').prop('contenteditable', 'true');
                    $('.note-toolbar button').prop('disabled', false).css('opacity', '1');
                }

                // Remove disabled styling
                $('.form-container').css({
                    'position': 'relative',
                    'opacity': '1'
                });

                // Restore button styling
                $('#submitBtn')
                    .html('<i class="fas fa-paper-plane me-2"></i> Submit for Review')
                    .addClass('btn-submit')
                    .removeClass('btn-secondary')
                    .css({
                        'opacity': '1',
                        'cursor': 'pointer'
                    });

                // Re-enable other buttons
                $('#previewBtn, #cancelBtn, #saveDraftBtn, #uploadFeaturedBtn, #removeImage, #addTagBtn')
                    .prop('disabled', false)
                    .css({
                        'opacity': '1',
                        'cursor': 'pointer'
                    });

                // Re-enable tag input
                $('#tagInput')
                    .prop('disabled', false)
                    .attr('placeholder', 'Add tags (press Enter)')
                    .css('opacity', '1');

                // Re-enable tag removal
                $('.remove-tag')
                    .css({
                        'pointer-events': 'auto',
                        'opacity': '1',
                        'cursor': 'pointer'
                    });

                // Re-enable popular tags suggestions
                $('.tag-suggestion')
                    .css({
                        'pointer-events': 'auto',
                        'opacity': '1',
                        'cursor': 'pointer',
                        'color': ''
                    })
                    .addClass('text-decoration-none');

            } else {
                // Disable all form elements
                formElements.prop('disabled', true);

                // Disable Summernote editor
                if ($('#content').summernote) {
                    $('#content').summernote('disable');
                    $('.note-editable').prop('contenteditable', 'false');
                }

                // Add disabled styling to the entire container
                $('.form-container').css({
                    'position': 'relative',
                    'opacity': '0.7'
                });

                // Style buttons as disabled
                form.find('button').css({
                    'opacity': '0.5',
                    'cursor': 'not-allowed'
                });
            }
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Auto-generate slug from title
            // Slug generation and validation
            let slugCheckTimeout = null;
            let currentSlug = '';

            $(document).ready(function () {
                // Generate slug button
                $('#generateSlugBtn').click(function () {
                    generateSlugFromTitle();
                });

                // Auto-generate when title loses focus (optional)
                $('#title').on('blur', function () {
                    if (!$('#slug').val()) {
                        generateSlugFromTitle();
                    }
                });

                // Check slug availability when slug changes
                $('#slug').on('input', function () {
                    checkSlugAvailability($(this).val());
                });

                // Also check when slug input loses focus
                $('#slug').on('blur', function () {
                    if ($(this).val()) {
                        checkSlugAvailability($(this).val());
                    }
                });

                // Manually trigger slug check on keyup with debounce
                $('#slug').on('keyup', function () {
                    clearTimeout(slugCheckTimeout);
                    slugCheckTimeout = setTimeout(() => {
                        if ($(this).val()) {
                            checkSlugAvailability($(this).val());
                        }
                    }, 500);
                });
            });

            function generateSlugFromTitle() {
                const title = $('#title').val().trim();

                if (!title) {
                    showToast('Please enter a title first', 'error');
                    $('#title').focus();
                    return;
                }

                // Show loading state
                $('#generateSlugBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Generating...');

                // Generate slug
                const generatedSlug = createSlug(title);

                // Set the slug value
                $('#slug').val(generatedSlug);

                // Check availability
                checkSlugAvailability(generatedSlug);

                // Restore button state
                setTimeout(() => {
                    $('#generateSlugBtn').prop('disabled', false).html('<i class="fas fa-magic me-1"></i> Generate');
                }, 500);
            }

            function createSlug(text) {
                return text
                    .toLowerCase()
                    .trim()
                    // Replace spaces with dashes
                    .replace(/\s+/g, '-')
                    // Remove special characters
                    .replace(/[^\w\-]+/g, '')
                    // Replace multiple dashes with single dash
                    .replace(/\-\-+/g, '-')
                    // Remove leading/trailing dashes
                    .replace(/^-+/, '')
                    .replace(/-+$/, '')
                    // Limit length
                    .substring(0, 100);
            }

            function checkSlugAvailability(slug) {
                if (!slug || slug.length < 3) {
                    hideSlugStatus();
                    return;
                }

                // Don't check if slug hasn't changed
                if (slug === currentSlug) return;

                currentSlug = slug;

                // Show checking state
                showSlugChecking();

                // Get current post ID (for edit mode)
                const postId = $('#postId').val() || 0;

                // Check availability via API
                $.ajax({
                    url: API_BASE + 'check_slug.php',
                    type: 'POST',
                    data: {
                        slug: slug,
                        post_id: postId
                    },
                    success: function (response) {
                        if (response.success) {
                            if (response.available) {
                                showSlugAvailable();
                            } else {
                                showSlugUnavailable(response.suggestions);
                            }
                        } else {
                            showSlugError(response.message || 'Error checking slug');
                        }
                    },
                    error: function () {
                        showSlugError('Error connecting to server');
                    }
                });
            }

            function showSlugChecking() {
                $('#slugAvailability').removeClass('d-none');
                $('#slugAvailabilityAlert')
                    .removeClass('alert-success alert-danger alert-warning')
                    .addClass('alert-info')
                    .html('<div class="d-flex align-items-center"><i class="fas fa-spinner fa-spin me-2"></i><span>Checking availability...</span></div>');
            }

            function showSlugAvailable() {
                $('#slugStatus').removeClass('d-none');
                $('#slugStatusIcon')
                    .removeClass('fa-times-circle fa-exclamation-circle')
                    .addClass('fa-check-circle text-success');
                $('#slugStatusText').text('✓ Slug is available').addClass('text-success').removeClass('text-danger text-warning');

                $('#slugAvailabilityAlert')
                    .removeClass('alert-info alert-danger alert-warning')
                    .addClass('alert-success')
                    .html('<div class="d-flex align-items-center"><i class="fas fa-check-circle me-2"></i><span>This slug is available!</span></div>');
            }

            function showSlugUnavailable(suggestions = []) {
                $('#slugStatus').removeClass('d-none');
                $('#slugStatusIcon')
                    .removeClass('fa-check-circle fa-exclamation-circle')
                    .addClass('fa-times-circle text-danger');
                $('#slugStatusText').text('✗ This slug is already taken').addClass('text-danger').removeClass('text-success text-warning');

                let suggestionsHtml = '<div class="d-flex align-items-center"><i class="fas fa-times-circle me-2"></i><span>This slug is already taken.</span></div>';

                if (suggestions && suggestions.length > 0) {
                    suggestionsHtml += '<div class="mt-2"><small>Suggestions:</small><div class="d-flex flex-wrap gap-2 mt-1">';
                    suggestions.forEach(suggestion => {
                        suggestionsHtml += `<button type="button" class="btn btn-sm btn-outline-primary slug-suggestion" data-slug="${suggestion}">${suggestion}</button>`;
                    });
                    suggestionsHtml += '</div></div>';
                }

                $('#slugAvailabilityAlert')
                    .removeClass('alert-info alert-success alert-warning')
                    .addClass('alert-danger')
                    .html(suggestionsHtml);

                // Add click handlers for suggestions
                $('.slug-suggestion').off('click').on('click', function () {
                    const suggestedSlug = $(this).data('slug');
                    $('#slug').val(suggestedSlug);
                    checkSlugAvailability(suggestedSlug);
                });
            }

            function showSlugError(message) {
                $('#slugStatus').removeClass('d-none');
                $('#slugStatusIcon')
                    .removeClass('fa-check-circle fa-times-circle')
                    .addClass('fa-exclamation-circle text-warning');
                $('#slugStatusText').text('⚠ ' + message).addClass('text-warning').removeClass('text-success text-danger');

                $('#slugAvailabilityAlert')
                    .removeClass('alert-info alert-success alert-danger')
                    .addClass('alert-warning')
                    .html(`<div class="d-flex align-items-center"><i class="fas fa-exclamation-triangle me-2"></i><span>${message}</span></div>`);
            }

            function hideSlugStatus() {
                $('#slugStatus').addClass('d-none');
                $('#slugAvailability').addClass('d-none');
                currentSlug = '';
            }

            // Featured image upload
            $('#uploadFeaturedBtn').click(function () {
                $('#featuredImage').click();
            });

            $('#featuredImage').change(function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Convert to base64 for preview
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        featuredImageBase64 = e.target.result;
                        $('#imagePreview').attr('src', featuredImageBase64).show();
                        $('#imagePlaceholder').hide();
                        $('#featuredImageUrl').val(featuredImageBase64);
                    };
                    reader.readAsDataURL(file);
                }
            });

            $('#imagePreviewContainer').click(function () {
                $('#featuredImage').click();
            });

            $('#removeImage').click(function () {
                $('#imagePreview').hide();
                $('#imagePlaceholder').show();
                $('#featuredImageUrl').val('');
                $('#featuredImage').val('');
                featuredImageBase64 = null;
            });

            // Tags management
            $('#tagInput').keypress(function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    addTag();
                }
            });

            $('#addTagBtn').click(addTag);

            // Tag suggestions
            $(document).on('click', '.tag-suggestion', function (e) {
                e.preventDefault();
                const tag = $(this).data('tag');
                $('#tagInput').val(tag);
                addTag();
            });

            // Form submission
            $('#blogForm').submit(function (e) {
                e.preventDefault();
                // Set status to pending when Update Post is clicked
                updateBlogPost('pending');
            });

            // Save draft button
            $('#saveDraftBtn').click(function () {
                // Set status to draft when Save Draft is clicked
                updateBlogPost('draft');
            });

            // Preview button
            $('#previewBtn').click(function () {
                previewBlogPost();
            });

            // Cancel button
            $('#cancelBtn').click(function () {
                if (confirm('Are you sure you want to cancel editing? Any unsaved changes will be lost.')) {
                    window.location.href = 'user-portal.html';
                }
            });

            // Success modal buttons
            $('#editAgainBtn').click(function () {
                $('#successModal').removeClass('show').hide();
                // Reload the page to get fresh data
                window.location.reload();
            });

            // $('#viewPostBtn').click(function () {
            //     window.open('blog-detail.html?slug=' + originalSlug, '_blank');
            // });

            $('#dashboardBtn').click(function () {
                window.location.href = 'user-portal.html';
            });
        }

        function addTag() {
            const tagInput = $('#tagInput');
            const tag = tagInput.val().trim().toLowerCase();

            if (tag && !tags.includes(tag)) {
                tags.push(tag);
                renderTags();
                tagInput.val('');
            }
        }

        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }

        function renderTags() {
            const container = $('#tagsContainer');
            container.empty();

            tags.forEach(tag => {
                const badge = `
                <span class="tag-badge">
                    ${tag}
                    <span class="remove-tag" onclick="removeTag('${tag}')">
                        <i class="fas fa-times"></i>
                    </span>
                </span>
            `;
                container.append(badge);
            });
        }

        function calculateReadingTime() {
            const content = $('#content').summernote('code');
            const text = $(content).text();
            const wordCount = text.split(/\s+/).length;
            const readingTime = Math.ceil(wordCount / 200); // 200 words per minute

            if (readingTime > 0) {
                $('#readingTime').val(readingTime);
            }
        }

        function updateBlogPost(status) {
            // Validate login first
            if (!currentUser) {
                showError('Please login to update blog posts');
                showLoginRequired();
                return;
            }

            // Prevent editing if post is pending
            if (originalStatus !== 'draft') {
                showError('This post is under review and cannot be edited.');
                return false;
            }

            // Validate required fields
            if (!$('#title').val()) {
                showError('Title is required');
                $('#title').focus();
                return;
            }

            if (!$('#category').val()) {
                showError('Category is required');
                $('#category').focus();
                return;
            }

            const content = $('#content').summernote('code');
            if (!content || content.trim() === '<p><br></p>') {
                showError('Content is required');
                return;
            }

            // Prepare data
            const blogData = {
                id: $('#postId').val(),
                title: $('#title').val(),
                slug: $('#slug').val() || generateSlug($('#title').val()),
                excerpt: $('#excerpt').val(),
                content: content,
                featured_image: featuredImageBase64 || $('#featuredImageUrl').val() || '',
                category: $('#category').val(),
                tags: tags,
                author_name: currentUser.name,
                author_email: currentUser.email || '',
                author_photo: currentUser.picture || '',
                reading_time: $('#readingTime').val(),
                status: status,
                user_id: currentUser.id,
                original_status: originalStatus
            };

            console.log('Updating blog data:', blogData);

            showLoading(true);
            $('#submitBtn').prop('disabled', true);
            $('#saveDraftBtn').prop('disabled', true);

            $.ajax({
                url: API_BASE + 'update_blog.php',
                type: 'POST',
                data: JSON.stringify(blogData),
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    if (response.success) {
                        // Update original status to reflect the new status
                        originalStatus = status;

                        const message = status === 'pending'
                            ? 'Blog updated and submitted for review!'
                            : 'Blog draft updated successfully!';

                        $('#successModalMessage').text(message);
                        $('#successModal').addClass('show').show();

                        showSuccess(message);

                        // If status is now pending, disable the form
                        if (status === 'pending') {
                            disableFormForPending();
                        }
                    } else {
                        showError(response.message || 'Failed to update blog post');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Update error:', error);
                    showError('Server error: ' + error);
                },
                complete: function () {
                    showLoading(false);
                    $('#submitBtn').prop('disabled', false);
                    $('#saveDraftBtn').prop('disabled', false);
                }
            });
        }

        function generateSlug(title) {
            return title.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function previewBlogPost() {
            const content = $('#content').summernote('code');
            const previewWindow = window.open('', '_blank');

            // Get preview image URL
            let previewImageUrl = '';
            if (featuredImageBase64) {
                previewImageUrl = featuredImageBase64;
            } else if ($('#featuredImageUrl').val()) {
                previewImageUrl = $('#featuredImageUrl').val();
            }

            const previewHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <title>Preview: ${$('#title').val()}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 20px; max-width: 800px; margin: 0 auto; }
                    .preview-header { border-bottom: 2px solid #3498db; padding-bottom: 20px; margin-bottom: 30px; }
                    .preview-image { width: 100%; max-height: 400px; object-fit: cover; border-radius: 10px; margin-bottom: 20px; }
                    .preview-meta { color: #666; font-size: 0.9rem; margin-bottom: 30px; }
                    .preview-content img { max-width: 100%; height: auto; }
                </style>
            </head>
            <body>
                <div class="preview-header">
                    <h1>${$('#title').val()}</h1>
                    <div class="preview-meta">
                        <span class="badge bg-primary">${$('#category').val()}</span>
                        <span class="ms-3"><i class="fas fa-user"></i> ${currentUser.name || 'Author'}</span>
                        <span class="ms-3"><i class="fas fa-clock"></i> ${$('#readingTime').val()} min read</span>
                    </div>
                </div>
                
                ${previewImageUrl ? `<img src="${previewImageUrl}" class="preview-image" alt="Featured Image">` : ''}
                
                <div class="preview-content">
                    ${content}
                </div>
                
                ${tags.length > 0 ? `
                    <div class="mt-5 pt-4 border-top">
                        <strong>Tags:</strong>
                        ${tags.map(tag => `<span class="badge bg-light text-dark me-2">${tag}</span>`).join('')}
                    </div>
                ` : ''}
            </body>
            </html>
        `;

            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
        }

        function showLoading(show) {
            if (show) {
                $('.loading-overlay').addClass('show').fadeIn();
            } else {
                $('.loading-overlay').removeClass('show').fadeOut();
            }
        }

        function showSuccess(message) {
            $('#successMessage').text(message);
            $('#successAlert').fadeIn();
            $('#errorAlert').hide();
        }

        function showError(message) {
            $('#errorMessage').text(message);
            $('#errorAlert').fadeIn();
            $('#successAlert').hide();
        }


        // Function to load categories from API
        function loadCategories() {
            $.ajax({
                url: API_BASE + 'get_categories.php',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    if (response.success && response.categories && response.categories.length > 0) {
                        populateCategories(response.categories);
                    } else {
                        // Show error message if no categories found
                        console.error('No categories found in response');
                        $('#category').html('<option value="">No categories available</option>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error loading categories:', error);
                    $('#category').html('<option value="">Error loading categories</option>');
                }
            });
        }

        function populateCategories(categories) {
            const $select = $('#category');
            $select.empty();

            // Add default option
            $select.append('<option value="">Select a category</option>');

            // Add categories from API
            categories.forEach(category => {
                // Use the 'name' field for display and 'slug' or 'name' for value
                const optionValue = category.slug || category.name;
                const optionText = category.name;

                const option = $('<option>', {
                    value: optionValue,
                    text: optionText
                });

                // If you want to select a category that was previously selected (for edit mode)
                if (window.selectedCategory && window.selectedCategory === optionValue) {
                    option.prop('selected', true);
                }

                // Add optional description as title attribute
                if (category.description) {
                    option.attr('title', category.description);
                }

                $select.append(option);
            });
        }
    </script>
</body>

</html>